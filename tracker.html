<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabit - Habit Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #0a0b0d;
            --secondary-bg: #141518;
            --card-bg: #1a1b1e;
            --border-color: #2a2b2e;
            --text-primary: #f1f3f4;
            --text-secondary: #9aa0a6;
            --text-muted: #5f6368;
            --accent-green: #34a853;
            --accent-blue: #4285f4;
            --accent-red: #ea4335;
            --accent-yellow: #fbbc04;
            --accent-purple: #9c27b0;
            --hover-overlay: rgba(255, 255, 255, 0.05);
            --completed-bg: rgba(52, 168, 83, 0.15);
            --completed-border: rgba(52, 168, 83, 0.4);
            --journal-font-size: 1rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .compact-mode .container,
        .compact-mode .settings-container {
            padding: 1rem;
        }

        .compact-mode .header {
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
        }

        .compact-mode .settings-section {
            padding: 1rem;
        }

        .compact-mode .setting-item {
            padding: 0.75rem 0;
        }

        .compact-mode .tracker-grid {
            gap: 0.5rem;
        }

        .compact-mode .journal-content {
            font-size: var(--journal-font-size);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            opacity: 0;
            animation: fadeIn 0.8s ease forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 1.8rem;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .month-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            color: var(--text-secondary);
            min-width: 140px;
            text-align: center;
        }

        .nav-btn {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'JetBrains Mono', monospace;
        }

        .nav-btn:hover {
            background: var(--hover-overlay);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: var(--accent-red);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: #d33;
        }

        .tracker-grid {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative;
        }

        .grid-header {
            display: flex;
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .date-column {
            flex: 0 0 80px;
            padding: 1rem 0.5rem;
            border-right: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            color: var(--text-secondary);
            text-align: center;
            font-size: 0.85rem;
        }

        .habit-column {
            flex: 1;
            min-width: 120px;
            padding: 1rem;
            border-right: 1px solid var(--border-color);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .habit-column:hover {
            background: var(--hover-overlay);
        }

        .habit-icon {
            font-size: 1.5rem;
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .habit-icon img {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: 6px;
        }

        .habit-name {
            font-size: 0.85rem;
            color: var(--text-primary);
            text-align: center;
            font-weight: 500;
        }

        .habit-type-badge {
            font-size: 0.7rem;
            color: var(--text-muted);
            background: var(--secondary-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            margin-top: 0.2rem;
        }

        .add-habit-column {
            flex: 0 0 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-muted);
            font-size: 2rem;
        }

        .add-habit-column:hover {
            background: var(--hover-overlay);
            color: var(--accent-green);
        }

        .grid-row {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .grid-row:last-child {
            border-bottom: none;
        }

        .date-cell {
            flex: 0 0 80px;
            padding: 0.8rem 0.5rem;
            border-right: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .date-cell.today {
            background: rgba(66, 133, 244, 0.1);
            color: var(--accent-blue);
        }

        .date-cell.past {
            color: var(--text-muted);
            background: rgba(95, 99, 104, 0.05);
        }

        .habit-cell {
            flex: 1;
            min-width: 120px;
            padding: 0.8rem;
            border-right: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .habit-cell.clickable:hover {
            background: var(--hover-overlay);
        }

        .habit-cell.completed {
            background: var(--completed-bg);
            border-left: 3px solid var(--accent-green);
        }

        .habit-cell.completed::after {
            content: "‚úì";
            color: var(--accent-green);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .habit-cell.not-completed {
            background: rgba(234, 67, 53, 0.15);
            border-left: 3px solid var(--accent-red);
        }

        .habit-cell.not-completed::after {
            content: "‚úó";
            color: var(--accent-red);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .habit-cell.blocked {
            background: rgba(95, 99, 104, 0.05);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Numeric cell styling */
        .habit-cell.numeric {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            justify-content: center;
            text-align: center;
            padding: 0.4rem;
        }

        .habit-cell.numeric::after {
            content: none;
        }

        .habit-cell.numeric.success {
            background: var(--completed-bg);
            border-left: 3px solid var(--accent-green);
            color: var(--accent-green);
        }

        .habit-cell.numeric.failure {
            background: rgba(234, 67, 53, 0.15);
            border-left: 3px solid var(--accent-red);
            color: var(--accent-red);
        }

        .habit-cell.numeric.empty {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            min-width: 400px;
            max-width: 500px;
            width: 90%;
            position: relative;
            animation: modalSlideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            color: var(--text-primary);
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .modal-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--hover-overlay);
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Tracking Type Selector */
        .tracking-type-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tracking-type-btn {
            flex: 1;
            padding: 0.5rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .tracking-type-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .numeric-options {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-col {
            flex: 1;
        }

        .form-col label {
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }

        .form-col select,
        .form-col input {
            margin-bottom: 0;
        }

        .range-inputs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .range-inputs input {
            flex: 1;
        }

        .range-inputs span {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Icon Type Selector */
        .icon-type-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .icon-type-btn {
            flex: 1;
            padding: 0.5rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .icon-type-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .icon-option-container {
            animation: fadeIn 0.3s ease;
        }

        /* Emoji Selector */
        .icon-selector {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .icon-option {
            background: var(--secondary-bg);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.5rem;
        }

        .icon-option:hover {
            border-color: var(--accent-blue);
        }

        .icon-option.selected {
            border-color: var(--accent-green);
            background: var(--completed-bg);
        }

        /* Upload Styles */
        .upload-area {
            position: relative;
        }

        .upload-label {
            display: block;
            cursor: pointer;
        }

        .upload-placeholder {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.2s ease;
            background: var(--secondary-bg);
        }

        .upload-placeholder:hover {
            border-color: var(--accent-blue);
            background: var(--hover-overlay);
        }

        .upload-placeholder .upload-icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 0.5rem;
        }

        .upload-placeholder small {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .upload-preview {
            position: relative;
            display: inline-block;
        }

        .upload-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--accent-green);
        }

        .remove-upload {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--accent-red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        input[type="file"] {
            display: none;
        }

        /* Numeric Input Modal */
        .numeric-input-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            backdrop-filter: blur(4px);
        }

        .numeric-input-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .numeric-input-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            width: 350px;
            text-align: center;
            animation: modalSlideIn 0.3s ease;
        }

        .numeric-input-content h3 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-size: 1.2rem;
        }

        .numeric-input-content .habit-info {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .numeric-input-content .current-range {
            color: var(--accent-blue);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .numeric-input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .numeric-input-group input {
            width: 120px;
            padding: 1rem;
            font-size: 1.2rem;
            text-align: center;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background: var(--secondary-bg);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .numeric-input-group input:focus {
            border-color: var(--accent-blue);
            outline: none;
        }

        .numeric-input-group .unit-label {
            color: var(--text-secondary);
            font-weight: 500;
            min-width: 40px;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #3367d6;
        }

        .btn-secondary {
            background: var(--secondary-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--hover-overlay);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-danger:hover {
            background: #d33;
        }

        .error-message {
            color: var(--accent-red);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .modal-content {
                min-width: 300px;
                padding: 1.5rem;
            }
            
            .icon-selector {
                grid-template-columns: repeat(4, 1fr);
            }

            .form-row {
                flex-direction: column;
            }

            .numeric-input-content {
                width: 300px;
            }
        }

        /* Navigation Ribbon */
        .top-nav {
            background: linear-gradient(135deg, var(--secondary-bg), var(--card-bg));
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 0;
            margin: -2rem -2rem 2rem -2rem; /* Extend to edges */
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        .nav-tab {
            padding: 0.6rem 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }

        .nav-tab:hover {
            background: var(--hover-overlay);
            color: var(--text-primary);
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }

        .nav-tab.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid var(--primary-bg);
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .nav-container {
                padding: 0 1rem;
                gap: 0.25rem;
            }
            
            .nav-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .nav-tab span {
                display: none; /* Hide text on mobile, show only icons */
            }
        }
    </style>
</head>
<body>

    <!-- Top Navigation Ribbon -->
    <nav class="top-nav">
        <div class="nav-container">
            <a href="tracker.html" class="nav-tab" id="nav-tracker">
                üìä <span>Tracker</span>
            </a>
            <a href="journal.html" class="nav-tab" id="nav-journal">
                üìù <span>Journal</span>
            </a>
            <a href="settings.html" class="nav-tab" id="nav-settings">
                ‚öôÔ∏è <span>Settings</span>
            </a>
            <a href="tips.html" class="nav-tab" id="nav-tips">
                üí° <span>Tips</span>
            </a>
        </div>
    </nav>

    <div class="container">
        <header class="header">
            <h1>tabit</h1>
            <div class="month-nav">
                <button class="nav-btn" id="prev-month">‚Äπ</button>
                <div class="month-display" id="current-month">December 2025</div>
                <button class="nav-btn" id="next-month">‚Ä∫</button>
            </div>
            <div class="user-info">
                <span id="user-email"></span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="tracker-grid" id="tracker-grid">
            <!-- Grid content will be generated by JavaScript -->
        </div>

        <!-- Empty state -->
        <div class="empty-state" id="empty-state" style="display: none;">
            <h3>Welcome to Tabit!</h3>
            <p>Start by creating your first habit to begin tracking.</p>
            <br>
            <button class="btn btn-primary" onclick="openAddHabitModal()">Create Your First Habit</button>
        </div>
    </div>

    <!-- Add Habit Modal -->
    <div class="modal" id="add-habit-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('add-habit-modal')">&times;</button>
            <div class="modal-header">
                <h2>Create New Habit</h2>
                <p>Add a new habit to start tracking your progress</p>
            </div>
            <form id="add-habit-form">
                <div class="form-group">
                    <label for="habit-name">Habit Name *</label>
                    <input type="text" id="habit-name" name="habit-name" required maxlength="50">
                    <div class="error-message" id="name-error">Please enter a habit name</div>
                </div>

                <div class="form-group">
                    <label>Tracking Type</label>
                    <div class="tracking-type-selector">
                        <button type="button" class="tracking-type-btn active" data-type="non-numeric" onclick="switchTrackingType('add', 'non-numeric')">‚úì Check/X</button>
                        <button type="button" class="tracking-type-btn" data-type="numeric" onclick="switchTrackingType('add', 'numeric')">üî¢ Numeric</button>
                    </div>
                    
                    <!-- Numeric options (hidden by default) -->
                    <div class="numeric-options" id="add-numeric-options" style="display: none;">
                        <div class="form-row">
                            <div class="form-col">
                                <label for="add-range-type">Range Type</label>
                                <select id="add-range-type" onchange="updateRangeInput('add')">
                                    <option value=">=">At least (‚â•)</option>
                                    <option value="<=">At most (‚â§)</option>
                                    <option value="range">Between</option>
                                    <option value="=">Exactly</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label>Value</label>
                                <div class="range-inputs">
                                    <input type="number" id="add-range-value" placeholder="8" step="0.1">
                                    <div id="add-range-between" style="display: none;">
                                        <span>to</span>
                                        <input type="number" id="add-range-max" placeholder="12" step="0.1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="add-metric-unit">Unit (e.g., hrs, cups, min)</label>
                            <input type="text" id="add-metric-unit" placeholder="hrs" maxlength="10">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Choose an Icon</label>
                    <div class="icon-type-selector">
                        <button type="button" class="icon-type-btn active" data-type="emoji" onclick="switchIconType('add', 'emoji')">üì± Emoji</button>
                        <button type="button" class="icon-type-btn" data-type="upload" onclick="switchIconType('add', 'upload')">üñºÔ∏è Upload</button>
                    </div>
                    
                    <!-- Emoji selector -->
                    <div class="icon-option-container" id="add-emoji-container">
                        <div class="icon-selector">
                            <div class="icon-option selected" data-icon="‚≠ê" data-type="emoji">‚≠ê</div>
                            <div class="icon-option" data-icon="üèÉ" data-type="emoji">üèÉ</div>
                            <div class="icon-option" data-icon="üíß" data-type="emoji">üíß</div>
                            <div class="icon-option" data-icon="üìñ" data-type="emoji">üìñ</div>
                            <div class="icon-option" data-icon="üßò" data-type="emoji">üßò</div>
                            <div class="icon-option" data-icon="üí™" data-type="emoji">üí™</div>
                            <div class="icon-option" data-icon="ü•ó" data-type="emoji">ü•ó</div>
                            <div class="icon-option" data-icon="üò¥" data-type="emoji">üò¥</div>
                            <div class="icon-option" data-icon="‚úçÔ∏è" data-type="emoji">‚úçÔ∏è</div>
                            <div class="icon-option" data-icon="üéµ" data-type="emoji">üéµ</div>
                            <div class="icon-option" data-icon="üß†" data-type="emoji">üß†</div>
                            <div class="icon-option" data-icon="‚ù§Ô∏è" data-type="emoji">‚ù§Ô∏è</div>
                        </div>
                    </div>
                    
                    <!-- Upload selector -->
                    <div class="icon-option-container" id="add-upload-container" style="display: none;">
                        <div class="upload-area">
                            <input type="file" id="add-icon-upload" accept="image/*" onchange="handleIconUpload('add', this)">
                            <label for="add-icon-upload" class="upload-label">
                                <div class="upload-placeholder">
                                    <span class="upload-icon">üìÅ</span>
                                    <span>Click to upload image</span>
                                    <small>PNG, JPG, GIF up to 2MB</small>
                                </div>
                            </label>
                            <div class="upload-preview" id="add-upload-preview" style="display: none;">
                                <img id="add-preview-img" src="" alt="Preview">
                                <button type="button" class="remove-upload" onclick="removeUpload('add')">‚úó</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="habit-reason">Why this habit? (Optional)</label>
                    <textarea id="habit-reason" name="habit-reason" placeholder="What motivates you to build this habit?"></textarea>
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-habit-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Habit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Habit Modal -->
    <div class="modal" id="edit-habit-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('edit-habit-modal')">&times;</button>
            <div class="modal-header">
                <h2>Edit Habit</h2>
                <p>Update your habit details</p>
            </div>
            <form id="edit-habit-form">
                <div class="form-group">
                    <label for="edit-habit-name">Habit Name *</label>
                    <input type="text" id="edit-habit-name" name="edit-habit-name" required maxlength="50">
                    <div class="error-message" id="edit-name-error">Please enter a habit name</div>
                </div>

                <div class="form-group">
                    <label>Tracking Type</label>
                    <div class="tracking-type-selector">
                        <button type="button" class="tracking-type-btn active" data-type="non-numeric" onclick="switchTrackingType('edit', 'non-numeric')">‚úì Check/X</button>
                        <button type="button" class="tracking-type-btn" data-type="numeric" onclick="switchTrackingType('edit', 'numeric')">üî¢ Numeric</button>
                    </div>
                    
                    <!-- Numeric options (hidden by default) -->
                    <div class="numeric-options" id="edit-numeric-options" style="display: none;">
                        <div class="form-row">
                            <div class="form-col">
                                <label for="edit-range-type">Range Type</label>
                                <select id="edit-range-type" onchange="updateRangeInput('edit')">
                                    <option value=">=">At least (‚â•)</option>
                                    <option value="<=">At most (‚â§)</option>
                                    <option value="range">Between</option>
                                    <option value="=">Exactly</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label>Value</label>
                                <div class="range-inputs">
                                    <input type="number" id="edit-range-value" placeholder="8" step="0.1">
                                    <div id="edit-range-between" style="display: none;">
                                        <span>to</span>
                                        <input type="number" id="edit-range-max" placeholder="12" step="0.1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-metric-unit">Unit (e.g., hrs, cups, min)</label>
                            <input type="text" id="edit-metric-unit" placeholder="hrs" maxlength="10">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Choose an Icon</label>
                    <div class="icon-type-selector">
                        <button type="button" class="icon-type-btn active" data-type="emoji" onclick="switchIconType('edit', 'emoji')">üì± Emoji</button>
                        <button type="button" class="icon-type-btn" data-type="upload" onclick="switchIconType('edit', 'upload')">üñºÔ∏è Upload</button>
                    </div>
                    
                    <!-- Emoji selector -->
                    <div class="icon-option-container" id="edit-emoji-container">
                        <div class="icon-selector">
                            <div class="icon-option" data-icon="‚≠ê" data-type="emoji">‚≠ê</div>
                            <div class="icon-option" data-icon="üèÉ" data-type="emoji">üèÉ</div>
                            <div class="icon-option" data-icon="üíß" data-type="emoji">üíß</div>
                            <div class="icon-option" data-icon="üìñ" data-type="emoji">üìñ</div>
                            <div class="icon-option" data-icon="üßò" data-type="emoji">üßò</div>
                            <div class="icon-option" data-icon="üí™" data-type="emoji">üí™</div>
                            <div class="icon-option" data-icon="ü•ó" data-type="emoji">ü•ó</div>
                            <div class="icon-option" data-icon="üò¥" data-type="emoji">üò¥</div>
                            <div class="icon-option" data-icon="‚úçÔ∏è" data-type="emoji">‚úçÔ∏è</div>
                            <div class="icon-option" data-icon="üéµ" data-type="emoji">üéµ</div>
                            <div class="icon-option" data-icon="üß†" data-type="emoji">üß†</div>
                            <div class="icon-option" data-icon="‚ù§Ô∏è" data-type="emoji">‚ù§Ô∏è</div>
                        </div>
                    </div>
                    
                    <!-- Upload selector -->
                    <div class="icon-option-container" id="edit-upload-container" style="display: none;">
                        <div class="upload-area">
                            <input type="file" id="edit-icon-upload" accept="image/*" onchange="handleIconUpload('edit', this)">
                            <label for="edit-icon-upload" class="upload-label">
                                <div class="upload-placeholder">
                                    <span class="upload-icon">üìÅ</span>
                                    <span>Click to upload image</span>
                                    <small>PNG, JPG, GIF up to 2MB</small>
                                </div>
                            </label>
                            <div class="upload-preview" id="edit-upload-preview" style="display: none;">
                                <img id="edit-preview-img" src="" alt="Preview">
                                <button type="button" class="remove-upload" onclick="removeUpload('edit')">‚úó</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-habit-reason">Why this habit? (Optional)</label>
                    <textarea id="edit-habit-reason" name="edit-habit-reason" placeholder="What motivates you to build this habit?"></textarea>
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn btn-danger" onclick="deleteHabit()">Delete Habit</button>
                    <div style="flex: 1;"></div>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-habit-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Numeric Input Modal -->
    <div class="numeric-input-modal" id="numeric-input-modal">
        <div class="numeric-input-content">
            <h3 id="numeric-habit-name">Enter Value</h3>
            <div class="habit-info" id="numeric-habit-info">Track your progress</div>
            <div class="current-range" id="numeric-current-range">Target: ‚â• 8</div>
            
            <div class="numeric-input-group">
                <input type="number" id="numeric-value-input" placeholder="0" step="0.1" autofocus>
                <span class="unit-label" id="numeric-unit-label">hrs</span>
            </div>
            
            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="closeNumericInput()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNumericValue()">Save</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/validation.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/auth-guard.js"></script>
    <script src="js/settings-loader.js"></script>

    <script>
        // Global variables
        let currentDate = new Date();
        let currentUser = null;
        let habits = [];
        let completions = {};
        let selectedIcon = '‚≠ê';
        let selectedIconType = 'emoji';
        let selectedTrackingType = 'non-numeric';
        let uploadedIconFile = null;
        let editingHabitId = null;
        let currentNumericHabit = null;
        let currentNumericDate = null;
        
        // Initialize the tracker - SINGLE EVENT LISTENER
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Tracker initializing...');
            
            // Set active navigation tab
            const currentPage = window.location.pathname.split('/').pop();
            const navTabs = {
                'tracker.html': 'nav-tracker',
                'journal.html': 'nav-journal', 
                'settings.html': 'nav-settings',
                'tips.html': 'nav-tips'
            };
            
            const activeTabId = navTabs[currentPage];
            if (activeTabId) {
                document.getElementById(activeTabId).classList.add('active');
            }
            
            // Wait for auth-guard to complete
            setTimeout(async () => {
                console.log('üîê Checking authentication...', window.currentUser);
                if (window.currentUser) {
                    currentUser = window.currentUser;
                    console.log('‚úÖ User authenticated:', currentUser.email);
                    document.getElementById('user-email').textContent = currentUser.email;
                    
                    try {
                        await loadHabits();
                        console.log('üìö Habits loaded:', habits.length);
                        renderTracker();
                        setupEventListeners();
                        console.log('üéâ Tracker initialized successfully');
                    } catch (error) {
                        console.error('‚ùå Error during initialization:', error);
                        alert('Failed to load tracker: ' + error.message);
                    }
                } else {
                    console.error('‚ùå No user found');
                }
            }, 500);
        });

        // Event listeners
        function setupEventListeners() {
            document.getElementById('prev-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderTracker();
            });

            document.getElementById('next-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderTracker();
            });

            // Add habit form submission
            document.getElementById('add-habit-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('üìù Creating habit...');
                await createHabit();
            });

            // Edit habit form submission
            document.getElementById('edit-habit-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('‚úèÔ∏è Updating habit...');
                await updateHabit();
            });

            // Icon selectors
            setupIconSelectors();

            // Numeric input enter key
            document.getElementById('numeric-value-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveNumericValue();
                }
            });

            // Close numeric modal on outside click
            document.getElementById('numeric-input-modal').addEventListener('click', (e) => {
                if (e.target.id === 'numeric-input-modal') {
                    closeNumericInput();
                }
            });
        }

        function setupIconSelectors() {
            // Add habit icon selector
            document.querySelectorAll('#add-habit-modal .icon-option').forEach(icon => {
                icon.addEventListener('click', () => {
                    document.querySelectorAll('#add-habit-modal .icon-option').forEach(i => i.classList.remove('selected'));
                    icon.classList.add('selected');
                    selectedIcon = icon.dataset.icon;
                });
            });

            // Edit habit icon selector
            document.querySelectorAll('#edit-habit-modal .icon-option').forEach(icon => {
                icon.addEventListener('click', () => {
                    document.querySelectorAll('#edit-habit-modal .icon-option').forEach(i => i.classList.remove('selected'));
                    icon.classList.add('selected');
                });
            });
        }

        // Tracking type switching
        function switchTrackingType(modal, type) {
            selectedTrackingType = type;
            
            // Update button states
            document.querySelectorAll(`#${modal}-habit-modal .tracking-type-btn`).forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            
            // Show/hide numeric options
            const numericOptions = document.getElementById(`${modal}-numeric-options`);
            numericOptions.style.display = type === 'numeric' ? 'block' : 'none';
            
            // Update required attributes dynamically
            updateRequiredFields(modal, type);
        }

        // Update required attributes based on tracking type
        function updateRequiredFields(modal, type) {
            const rangeValue = document.getElementById(`${modal}-range-value`);
            const metricUnit = document.getElementById(`${modal}-metric-unit`);
            
            if (type === 'numeric') {
                rangeValue.setAttribute('required', '');
                metricUnit.setAttribute('required', '');
            } else {
                rangeValue.removeAttribute('required');
                metricUnit.removeAttribute('required');
            }
        }

        // Range input handling
        function updateRangeInput(modal) {
            const rangeType = document.getElementById(`${modal}-range-type`).value;
            const betweenDiv = document.getElementById(`${modal}-range-between`);
            
            betweenDiv.style.display = rangeType === 'range' ? 'flex' : 'none';
        }

        // Icon type switching
        function switchIconType(modal, type) {
            selectedIconType = type;
            const prefix = modal;
            
            // Update button states
            document.querySelectorAll(`#${modal}-habit-modal .icon-type-btn`).forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            
            // Show/hide containers
            document.getElementById(`${prefix}-emoji-container`).style.display = type === 'emoji' ? 'block' : 'none';
            document.getElementById(`${prefix}-upload-container`).style.display = type === 'upload' ? 'block' : 'none';
            
            // Reset selections
            if (type === 'emoji') {
                uploadedIconFile = null;
                document.getElementById(`${prefix}-upload-preview`).style.display = 'none';
                const placeholder = document.querySelector(`#${prefix}-upload-container .upload-placeholder`);
                if (placeholder) placeholder.style.display = 'block';
            } else {
                document.querySelectorAll(`#${modal}-habit-modal .icon-option`).forEach(i => i.classList.remove('selected'));
                selectedIcon = null;
            }
        }

        // Handle icon upload
        async function handleIconUpload(modal, input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validate file
            if (file.size > 2 * 1024 * 1024) { // 2MB
                alert('File size must be less than 2MB');
                input.value = '';
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                input.value = '';
                return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById(`${modal}-upload-preview`);
                const img = document.getElementById(`${modal}-preview-img`);
                
                img.src = e.target.result;
                preview.style.display = 'block';
                const placeholder = document.querySelector(`#${modal}-upload-container .upload-placeholder`);
                if (placeholder) placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            uploadedIconFile = file;
        }

        // Remove upload
        function removeUpload(modal) {
            uploadedIconFile = null;
            document.getElementById(`${modal}-upload-preview`).style.display = 'none';
            const placeholder = document.querySelector(`#${modal}-upload-container .upload-placeholder`);
            if (placeholder) placeholder.style.display = 'block';
            document.getElementById(`${modal}-icon-upload`).value = '';
        }

        // Upload file to Supabase Storage
        async function uploadIconToStorage(file, userId) {
            const fileName = `${userId}/${Date.now()}_${file.name}`;
            
            const { data, error } = await sb.storage
                .from('habit-icons')
                .upload(fileName, file);
                
            if (error) throw error;
            
            // Get public URL
            const { data: publicData } = sb.storage
                .from('habit-icons')
                .getPublicUrl(fileName);
                
            return publicData.publicUrl;
        }

        // Generate range string for database storage
        function generateRangeString(modal) {
            const rangeType = document.getElementById(`${modal}-range-type`).value;
            const value = document.getElementById(`${modal}-range-value`).value;
            const maxValue = document.getElementById(`${modal}-range-max`).value;
            
            switch (rangeType) {
                case '>=':
                    return `>=${value}`;
                case '<=':
                    return `<=${value}`;
                case '=':
                    return `=${value}`;
                case 'range':
                    return `${value}-${maxValue}`;
                default:
                    return `>=${value}`;
            }
        }

        // Parse range string for display
        function parseRangeString(rangeStr) {
            if (!rangeStr) return { type: '>=', value: 0, max: null };
            
            if (rangeStr.includes('-')) {
                const [min, max] = rangeStr.split('-');
                return { type: 'range', value: parseFloat(min), max: parseFloat(max) };
            } else if (rangeStr.startsWith('>=')) {
                return { type: '>=', value: parseFloat(rangeStr.substring(2)), max: null };
            } else if (rangeStr.startsWith('<=')) {
                return { type: '<=', value: parseFloat(rangeStr.substring(2)), max: null };
            } else if (rangeStr.startsWith('=')) {
                return { type: '=', value: parseFloat(rangeStr.substring(1)), max: null };
            }
            
            return { type: '>=', value: parseFloat(rangeStr), max: null };
        }

        // Format range for display
        function formatRangeDisplay(rangeStr) {
            const { type, value, max } = parseRangeString(rangeStr);
            
            switch (type) {
                case '>=':
                    return `‚â• ${value}`;
                case '<=':
                    return `‚â§ ${value}`;
                case '=':
                    return `= ${value}`;
                case 'range':
                    return `${value} - ${max}`;
                default:
                    return rangeStr;
            }
        }

        // Validate numeric value against range
        function validateNumericValue(value, rangeStr) {
            const { type, value: targetValue, max } = parseRangeString(rangeStr);
            const numValue = parseFloat(value);
            
            switch (type) {
                case '>=':
                    return numValue >= targetValue;
                case '<=':
                    return numValue <= targetValue;
                case '=':
                    return numValue === targetValue;
                case 'range':
                    return numValue >= targetValue && numValue <= max;
                default:
                    return false;
            }
        }

        // Database operations
        async function loadHabits() {
            try {
                const { data, error } = await sb
                    .from('habits')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: true });

                if (error) throw error;
                habits = data || [];
                await loadCompletions();
            } catch (error) {
                console.error('Error loading habits:', error);
                alert('Failed to load habits: ' + error.message);
            }
        }

        async function loadCompletions() {
            try {
                const startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

                const { data, error } = await sb
                    .from('habit_completions')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('completion_date', startDate.toISOString())
                    .lte('completion_date', endDate.toISOString());

                if (error) throw error;

                // Convert to lookup object
                completions = {};
                data.forEach(completion => {
                    const key = `${completion.habit_id}-${completion.completion_date.split('T')[0]}`;
                    completions[key] = completion;
                });
            } catch (error) {
                console.error('Error loading completions:', error);
            }
        }

        async function createHabit() {
            console.log('üìù Starting habit creation...');
            const form = document.getElementById('add-habit-form');
            const nameInput = document.getElementById('habit-name');

            // Basic validation
            if (!validateHabitForm(nameInput, 'name-error')) {
                console.log('‚ùå Name validation failed');
                return;
            }
            
            if (selectedIconType === 'emoji' && !selectedIcon) {
                alert('Please select an emoji icon');
                console.log('‚ùå No emoji selected');
                return;
            }
            
            if (selectedIconType === 'upload' && !uploadedIconFile) {
                alert('Please upload an icon image');
                console.log('‚ùå No icon uploaded');
                return;
            }

            // Validate numeric options only if numeric tracking is selected
            if (selectedTrackingType === 'numeric') {
                const rangeValue = document.getElementById('add-range-value').value;
                const metricUnit = document.getElementById('add-metric-unit').value;
                
                if (!rangeValue) {
                    alert('Please enter a range value for numeric tracking');
                    console.log('‚ùå Missing range value');
                    return;
                }
                
                if (!metricUnit.trim()) {
                    alert('Please enter a unit for numeric tracking');
                    console.log('‚ùå Missing metric unit');
                    return;
                }
                
                const rangeType = document.getElementById('add-range-type').value;
                if (rangeType === 'range') {
                    const maxValue = document.getElementById('add-range-max').value;
                    if (!maxValue) {
                        alert('Please enter the maximum value for range tracking');
                        console.log('‚ùå Missing max value for range');
                        return;
                    }
                }
            }

            try {
                form.classList.add('loading');
                console.log('üîÑ Form validation passed, creating habit...');
                
                let iconKey = selectedIcon;
                let iconKind = 'emoji';
                
                // Handle file upload
                if (selectedIconType === 'upload' && uploadedIconFile) {
                    console.log('üì§ Uploading icon...');
                    iconKey = await uploadIconToStorage(uploadedIconFile, currentUser.id);
                    iconKind = 'uploaded';
                    console.log('‚úÖ Icon uploaded:', iconKey);
                }

                // Prepare habit data
                const habitData = {
                    habit_name: nameInput.value.trim(),
                    user_id: currentUser.id,
                    icon_kind: iconKind,
                    icon_key: iconKey,
                    habit_type: selectedTrackingType,
                    created_at: new Date().toISOString()
                };

                // Add numeric fields if needed
                if (selectedTrackingType === 'numeric') {
                    habitData.numeric_range = generateRangeString('add');
                    habitData.metric_unit = document.getElementById('add-metric-unit').value.trim();
                    console.log('üî¢ Adding numeric fields:', habitData.numeric_range, habitData.metric_unit);
                }

                console.log('üíæ Saving to database:', habitData);
                const { data, error } = await sb
                    .from('habits')
                    .insert([habitData])
                    .select();

                if (error) {
                    console.error('‚ùå Database error:', error);
                    throw error;
                }

                console.log('‚úÖ Habit created successfully:', data[0]);

                // Add to local array
                habits.push(data[0]);
                
                // Clear form and close modal
                form.reset();
                resetModalState('add');
                closeModal('add-habit-modal');
                
                // Re-render tracker
                renderTracker();
                console.log('üéâ Habit creation completed');

            } catch (error) {
                console.error('‚ùå Error creating habit:', error);
                alert('Failed to create habit: ' + error.message);
            } finally {
                form.classList.remove('loading');
            }
        }

        async function updateHabit() {
            console.log('‚úèÔ∏è Starting habit update...', editingHabitId);
            const form = document.getElementById('edit-habit-form');
            const nameInput = document.getElementById('edit-habit-name');
            
            // Validation
            if (!validateHabitForm(nameInput, 'edit-name-error')) return;

            try {
                form.classList.add('loading');

                let iconKey, iconKind;
                
                if (selectedIconType === 'emoji') {
                    const selectedIconEl = document.querySelector('#edit-habit-modal .icon-option.selected');
                    if (!selectedIconEl) {
                        alert('Please select an emoji icon');
                        return;
                    }
                    iconKey = selectedIconEl.dataset.icon;
                    iconKind = 'emoji';
                } else if (selectedIconType === 'upload' && uploadedIconFile && uploadedIconFile !== 'existing') {
                    iconKey = await uploadIconToStorage(uploadedIconFile, currentUser.id);
                    iconKind = 'uploaded';
                } else {
                    // Keep existing icon
                    const existingHabit = habits.find(h => h.id === editingHabitId);
                    iconKey = existingHabit.icon_key;
                    iconKind = existingHabit.icon_kind;
                }

                // Prepare update data
                const updateData = {
                    habit_name: nameInput.value.trim(),
                    icon_kind: iconKind,
                    icon_key: iconKey,
                    habit_type: selectedTrackingType
                };

                // Add numeric fields if needed
                if (selectedTrackingType === 'numeric') {
                    const rangeValue = document.getElementById('edit-range-value').value;
                    const metricUnit = document.getElementById('edit-metric-unit').value;
                    
                    if (!rangeValue || !metricUnit.trim()) {
                        alert('Please fill in all numeric tracking fields');
                        return;
                    }
                    
                    updateData.numeric_range = generateRangeString('edit');
                    updateData.metric_unit = metricUnit.trim();
                } else {
                    // Clear numeric fields if switching to non-numeric
                    updateData.numeric_range = null;
                    updateData.metric_unit = null;
                }

                console.log('üíæ Updating habit:', updateData);
                const { error } = await sb
                    .from('habits')
                    .update(updateData)
                    .eq('id', editingHabitId);

                if (error) {
                    console.error('‚ùå Update error:', error);
                    throw error;
                }

                // Update local array
                const habitIndex = habits.findIndex(h => h.id === editingHabitId);
                if (habitIndex !== -1) {
                    habits[habitIndex] = { ...habits[habitIndex], ...updateData };
                }

                console.log('‚úÖ Habit updated successfully');
                closeModal('edit-habit-modal');
                renderTracker();

            } catch (error) {
                console.error('‚ùå Error updating habit:', error);
                alert('Failed to update habit: ' + error.message);
            } finally {
                form.classList.remove('loading');
            }
        }

        async function deleteHabit() {
            if (!confirm('Are you sure you want to delete this habit? This action cannot be undone.')) return;

            try {
                console.log('üóëÔ∏è Deleting habit:', editingHabitId);
                
                // First delete all completions for this habit
                await sb
                    .from('habit_completions')
                    .delete()
                    .eq('habit_id', editingHabitId);

                // Then delete the habit
                const { error } = await sb
                    .from('habits')
                    .delete()
                    .eq('id', editingHabitId);

                if (error) throw error;

                // Remove from local array
                habits = habits.filter(h => h.id !== editingHabitId);

                console.log('‚úÖ Habit deleted successfully');
                closeModal('edit-habit-modal');
                renderTracker();

            } catch (error) {
                console.error('‚ùå Error deleting habit:', error);
                alert('Failed to delete habit: ' + error.message);
            }
        }

        // Handle habit cell clicks
        function handleHabitCellClick(habit, date) {
            if (habit.habit_type === 'numeric') {
                openNumericInput(habit, date);
            } else {
                toggleCompletion(habit.id, date);
            }
        }

        // Non-numeric completion toggle (original logic)
        async function toggleCompletion(habitId, date) {
            const dateStr = date.toISOString().split('T')[0];
            const key = `${habitId}-${dateStr}`;
            const existing = completions[key];

            try {
                if (!existing) {
                    // State 1: Empty ‚Üí Completed (green check)
                    const { data, error } = await sb
                        .from('habit_completions')
                        .insert([{
                            habit_id: habitId,
                            user_id: currentUser.id,
                            completion_date: dateStr,
                            is_completed: true,
                            created_at: new Date().toISOString()
                        }])
                        .select();

                    if (error) throw error;
                    completions[key] = data[0];
                    
                } else if (existing.is_completed) {
                    // State 2: Completed ‚Üí Not Completed (red X)
                    const { error } = await sb
                        .from('habit_completions')
                        .update({
                            is_completed: false
                        })
                        .eq('id', existing.id);

                    if (error) throw error;
                    completions[key].is_completed = false;
                    
                } else {
                    // State 3: Not Completed ‚Üí Empty (remove record)
                    const { error } = await sb
                        .from('habit_completions')
                        .delete()
                        .eq('id', existing.id);

                    if (error) throw error;
                    delete completions[key];
                }

                renderTracker();
            } catch (error) {
                console.error('Error toggling completion:', error);
                alert('Failed to update completion: ' + error.message);
            }
        }

        // Numeric input functions
        function openNumericInput(habit, date) {
            currentNumericHabit = habit;
            currentNumericDate = date;
            
            // Set modal content
            document.getElementById('numeric-habit-name').textContent = habit.habit_name;
            document.getElementById('numeric-habit-info').textContent = `Track your ${habit.habit_name.toLowerCase()}`;
            document.getElementById('numeric-current-range').textContent = `Target: ${formatRangeDisplay(habit.numeric_range)}`;
            document.getElementById('numeric-unit-label').textContent = habit.metric_unit;
            
            // Pre-fill existing value if any
            const dateStr = date.toISOString().split('T')[0];
            const key = `${habit.id}-${dateStr}`;
            const existing = completions[key];
            const input = document.getElementById('numeric-value-input');
            
            input.value = existing && existing.numeric_value ? existing.numeric_value : '';
            
            // Show modal
            document.getElementById('numeric-input-modal').classList.add('active');
            setTimeout(() => input.focus(), 100);
        }

        function closeNumericInput() {
            document.getElementById('numeric-input-modal').classList.remove('active');
            currentNumericHabit = null;
            currentNumericDate = null;
            document.getElementById('numeric-value-input').value = '';
        }

        async function saveNumericValue() {
            const input = document.getElementById('numeric-value-input');
            const value = parseFloat(input.value);
            
            if (isNaN(value)) {
                alert('Please enter a valid number');
                return;
            }

            const habit = currentNumericHabit;
            const date = currentNumericDate;
            const dateStr = date.toISOString().split('T')[0];
            const key = `${habit.id}-${dateStr}`;
            const existing = completions[key];
            
            // Validate against range
            const isCompleted = validateNumericValue(value, habit.numeric_range);

            try {
                if (existing) {
                    // Update existing record
                    const { error } = await sb
                        .from('habit_completions')
                        .update({
                            numeric_value: value,
                            is_completed: isCompleted
                        })
                        .eq('id', existing.id);

                    if (error) throw error;
                    
                    completions[key].numeric_value = value;
                    completions[key].is_completed = isCompleted;
                } else {
                    // Create new record
                    const { data, error } = await sb
                        .from('habit_completions')
                        .insert([{
                            habit_id: habit.id,
                            user_id: currentUser.id,
                            completion_date: dateStr,
                            numeric_value: value,
                            is_completed: isCompleted,
                            created_at: new Date().toISOString()
                        }])
                        .select();

                    if (error) throw error;
                    completions[key] = data[0];
                }

                closeNumericInput();
                renderTracker();

            } catch (error) {
                console.error('Error saving numeric value:', error);
                alert('Failed to save value: ' + error.message);
            }
        }

        // UI functions
        function renderTracker() {
            updateMonthDisplay();
            
            if (habits.length === 0) {
                document.getElementById('tracker-grid').style.display = 'none';
                document.getElementById('empty-state').style.display = 'block';
                return;
            }

            document.getElementById('tracker-grid').style.display = 'block';
            document.getElementById('empty-state').style.display = 'none';

            const grid = document.getElementById('tracker-grid');
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const today = new Date();
            
            grid.innerHTML = `
                <div class="grid-header">
                    <div class="date-column">Date</div>
                    ${habits.map(habit => `
                        <div class="habit-column" onclick="openEditHabitModal(${habit.id})">
                            <div class="habit-icon">
                                ${habit.icon_kind === 'uploaded' 
                                    ? `<img src="${habit.icon_key}" alt="${habit.habit_name}">`
                                    : habit.icon_key
                                }
                            </div>
                            <div class="habit-name">${habit.habit_name}</div>
                            <div class="habit-type-badge">${habit.habit_type === 'numeric' ? habit.metric_unit || 'numeric' : 'check'}</div>
                        </div>
                    `).join('')}
                    <div class="add-habit-column" onclick="openAddHabitModal()">+</div>
                </div>
                ${Array.from({length: daysInMonth}, (_, i) => {
                    const day = i + 1;
                    const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                    const isPast = date < today && date.toDateString() !== today.toDateString();
                    const isToday = date.toDateString() === today.toDateString();
                    
                    return `
                        <div class="grid-row">
                            <div class="date-cell ${isToday ? 'today' : ''} ${isPast ? 'past' : ''}">
                                ${day}
                            </div>
                            ${habits.map(habit => {
                                const key = `${habit.id}-${date.toISOString().split('T')[0]}`;
                                const completion = completions[key];
                                const isClickable = !isPast;
                                
                                if (habit.habit_type === 'numeric') {
                                    // Numeric cell
                                    if (completion && completion.numeric_value !== null) {
                                        const success = completion.is_completed ? 'success' : 'failure';
                                        return `
                                            <div class="habit-cell numeric ${success} ${isPast ? 'blocked' : 'clickable'}" 
                                                 ${isClickable ? `onclick="handleHabitCellClick(${JSON.stringify(habit).replace(/"/g, '&quot;')}, new Date('${date.toISOString()}'))"` : ''}>
                                                ${completion.numeric_value} ${habit.metric_unit}
                                            </div>
                                        `;
                                    } else {
                                        return `
                                            <div class="habit-cell numeric empty ${isPast ? 'blocked' : 'clickable'}" 
                                                 ${isClickable ? `onclick="handleHabitCellClick(${JSON.stringify(habit).replace(/"/g, '&quot;')}, new Date('${date.toISOString()}'))"` : ''}>
                                                --
                                            </div>
                                        `;
                                    }
                                } else {
                                    // Non-numeric cell (original logic)
                                    let cellClass = '';
                                    if (completion) {
                                        cellClass = completion.is_completed ? 'completed' : 'not-completed';
                                    }
                                    
                                    return `
                                        <div class="habit-cell ${cellClass} ${isPast ? 'blocked' : 'clickable'}" 
                                             ${isClickable ? `onclick="toggleCompletion(${habit.id}, new Date('${date.toISOString()}'))"` : ''}>
                                        </div>
                                    `;
                                }
                            }).join('')}
                            <div style="flex: 0 0 120px;"></div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function updateMonthDisplay() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('current-month').textContent = 
                `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        }

        function validateHabitForm(nameInput, errorId) {
            const nameError = document.getElementById(errorId);
            
            if (!nameInput.value.trim()) {
                nameError.style.display = 'block';
                nameInput.focus();
                return false;
            }
            
            nameError.style.display = 'none';
            return true;
        }

        function resetModalState(modal) {
            selectedIcon = '‚≠ê';
            selectedIconType = 'emoji';
            selectedTrackingType = 'non-numeric';
            uploadedIconFile = null;
            
            // Reset tracking type buttons
            document.querySelectorAll(`#${modal}-habit-modal .tracking-type-btn`).forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === 'non-numeric');
            });
            
            // Hide numeric options and remove required attributes
            const numericOptions = document.getElementById(`${modal}-numeric-options`);
            numericOptions.style.display = 'none';
            updateRequiredFields(modal, 'non-numeric');
            
            // Reset icon type buttons
            document.querySelectorAll(`#${modal}-habit-modal .icon-type-btn`).forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === 'emoji');
            });
            
            // Reset containers
            document.getElementById(`${modal}-emoji-container`).style.display = 'block';
            document.getElementById(`${modal}-upload-container`).style.display = 'none';
            
            // Reset selections
            document.querySelectorAll(`#${modal}-habit-modal .icon-option`).forEach(i => i.classList.remove('selected'));
            document.querySelector(`#${modal}-habit-modal .icon-option[data-icon="‚≠ê"]`).classList.add('selected');
            
            // Reset upload area
            document.getElementById(`${modal}-upload-preview`).style.display = 'none';
            const placeholder = document.querySelector(`#${modal}-upload-container .upload-placeholder`);
            if (placeholder) placeholder.style.display = 'block';
            document.getElementById(`${modal}-icon-upload`).value = '';

            // Reset range input
            updateRangeInput(modal);
        }

        // Modal functions
        function openAddHabitModal() {
            resetModalState('add');
            const modal = document.getElementById('add-habit-modal');
            modal.classList.add('active');
            document.getElementById('habit-name').focus();
        }

        function openEditHabitModal(habitId) {
            editingHabitId = habitId;
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;

            // Set basic fields
            document.getElementById('edit-habit-name').value = habit.habit_name;
            
            // Set tracking type
            selectedTrackingType = habit.habit_type || 'non-numeric';
            document.querySelectorAll('#edit-habit-modal .tracking-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === selectedTrackingType);
            });
            
            // Show/hide numeric options and update required fields
            const numericOptions = document.getElementById('edit-numeric-options');
            numericOptions.style.display = selectedTrackingType === 'numeric' ? 'block' : 'none';
            updateRequiredFields('edit', selectedTrackingType);
            
            // Set numeric fields if applicable
            if (selectedTrackingType === 'numeric') {
                const { type, value, max } = parseRangeString(habit.numeric_range);
                
                document.getElementById('edit-range-type').value = type;
                document.getElementById('edit-range-value').value = value;
                document.getElementById('edit-metric-unit').value = habit.metric_unit || '';
                
                if (type === 'range') {
                    document.getElementById('edit-range-max').value = max;
                    document.getElementById('edit-range-between').style.display = 'flex';
                } else {
                    document.getElementById('edit-range-between').style.display = 'none';
                }
            }
            
            // Set icon type and selection
            if (habit.icon_kind === 'uploaded') {
                selectedIconType = 'upload';
                uploadedIconFile = 'existing'; // Flag that we have existing upload
                
                // Show upload container with existing image
                document.querySelectorAll('#edit-habit-modal .icon-type-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.type === 'upload');
                });
                document.getElementById('edit-emoji-container').style.display = 'none';
                document.getElementById('edit-upload-container').style.display = 'block';
                
                // Show existing image
                const preview = document.getElementById('edit-upload-preview');
                const img = document.getElementById('edit-preview-img');
                img.src = habit.icon_key;
                preview.style.display = 'block';
                document.querySelector('#edit-upload-container .upload-placeholder').style.display = 'none';
            } else {
                selectedIconType = 'emoji';
                
                // Show emoji container with selected emoji
                document.querySelectorAll('#edit-habit-modal .icon-type-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.type === 'emoji');
                });
                document.getElementById('edit-emoji-container').style.display = 'block';
                document.getElementById('edit-upload-container').style.display = 'none';
                
                // Set selected emoji
                document.querySelectorAll('#edit-habit-modal .icon-option').forEach(i => i.classList.remove('selected'));
                const iconEl = document.querySelector(`#edit-habit-modal .icon-option[data-icon="${habit.icon_key}"]`);
                if (iconEl) iconEl.classList.add('selected');
            }

            const modal = document.getElementById('edit-habit-modal');
            modal.classList.add('active');
            document.getElementById('edit-habit-name').focus();
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
            
            // Reset forms
            if (modalId === 'add-habit-modal') {
                document.getElementById('add-habit-form').reset();
                document.querySelectorAll('#add-habit-modal .error-message').forEach(err => err.style.display = 'none');
                resetModalState('add');
            } else if (modalId === 'edit-habit-modal') {
                document.getElementById('edit-habit-form').reset();
                document.querySelectorAll('#edit-habit-modal .error-message').forEach(err => err.style.display = 'none');
                editingHabitId = null;
            }
        }

        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
    </script>
</body>
</html>